# Stage 1: build React app
FROM registry.access.redhat.com/ubi9/nodejs-18 AS builder

WORKDIR /app
USER 0

COPY package.json ./
RUN npm install

COPY . .
RUN npm run build

# Stage 2: minimal image with nginx
FROM registry.access.redhat.com/ubi9/nginx-120

USER 0

# Limpa pasta html padrão para garantir zero lixo antigo
RUN rm -rf /usr/share/nginx/html/*

# Copia arquivos buildados
COPY --from=builder /app/build/ /usr/share/nginx/html/

# Configuração customizada do nginx
COPY nginx.conf /etc/nginx/conf.d/default.conf

# Corrige permissões (muito importante no UBI)
RUN chmod -R 755 /usr/share/nginx/html

EXPOSE 8080

CMD ["nginx", "-g", "daemon off;"]

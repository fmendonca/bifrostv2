# Base UBI9
FROM registry.access.redhat.com/ubi9/ubi

# Versões
ENV RABBITMQ_VERSION=4.1.2 \
    ERLANG_VERSION=26.2

# Instalar dependências e RabbitMQ
RUN dnf install -y \
        curl \
        gnupg \
        hostname \
        socat \
        which \
        logrotate && \
    curl -fsSL https://packages.erlang-solutions.com/erlang-solutions-2.0-1.noarch.rpm -o erlang-solutions.rpm && \
    dnf install -y erlang-solutions.rpm && \
    dnf install -y erlang-$ERLANG_VERSION && \
    curl -fsSL https://github.com/rabbitmq/rabbitmq-server/releases/download/v${RABBITMQ_VERSION}/rabbitmq-server-${RABBITMQ_VERSION}-1.el8.noarch.rpm -o rabbitmq.rpm && \
    rpm -ivh rabbitmq.rpm && \
    dnf clean all && \
    rm -f erlang-solutions.rpm rabbitmq.rpm

# Criar usuário rabbitmq
RUN useradd -r -m rabbitmq

# Expor portas padrão
EXPOSE 5672 15672

# Volumes para persistência
VOLUME ["/var/lib/rabbitmq", "/etc/rabbitmq"]

# Variáveis padrão (podem ser sobrescritas no docker run/podman run)
ENV RABBITMQ_DEFAULT_USER=admin \
    RABBITMQ_DEFAULT_PASS=admin

# Copiar script de inicialização customizado
COPY docker-entrypoint.sh /usr/local/bin/docker-entrypoint.sh
RUN chmod +x /usr/local/bin/docker-entrypoint.sh

# Definir usuário e comando
USER rabbitmq
ENTRYPOINT ["/usr/local/bin/docker-entrypoint.sh"]
